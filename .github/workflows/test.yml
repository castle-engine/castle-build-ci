# ----------------------------------------------------------------------------
# GitHub Actions workflow to test this script.
# ----------------------------------------------------------------------------

name: Test

on: [push, pull_request]

defaults:
  run:
    shell: bash

jobs:
  # Build on regular desktop platforms for which we have GitHub-hosted runners.
  build:
    name: Build
    strategy:
      matrix:
        runner: [
          ubuntu-latest,
          windows-latest,
          macos-latest, # macOS with Aarch64 (macOS Silicon)
          macos-15-intel # last macOS with Intel
        ]
    runs-on: ${{ matrix.runner }}
    steps:
      - name: Checkout application
        uses: actions/checkout@v6

      - name: Setup Castle Game Engine
        run: |
          cd /tmp/ # temporary directory, to be separate from the current project files
          git clone https://github.com/castle-engine/castle-build-ci.git \
            --depth=1 --single-branch --branch=master
          castle-build-ci/install_dependencies
          castle-build-ci/setup_castle_engine

      - name: Package
        run: cd test_project && castle-engine package --verbose

      - name: Archive Artifacts
        uses: actions/upload-artifact@v6
        with:
          name: build-${{ matrix.runner }}
          path: |
            test_project/*.zip
            test_project/*.tar.gz
            test_project/*.apk
          if-no-files-found: error

  # Build on ARM runners (for Raspberry Pi) using pguyot/arm-runner-action .
  build_arm_runner:
    name: Build on ARM Runner (for Raspberry Pi)
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [raspberry-pi-32, raspberry-pi-64]
        include:
        # additional defines for Raspberry Pi 32-bit (Arm)
        - arch: raspberry-pi-32
          # Arguments for pguyot/arm-runner-action
          cpu: cortex-a7
          base_image: raspios_lite:latest
        # additional defines for Raspberry Pi 64-bit (Aarch64)
        - arch: raspberry-pi-64
          # Arguments for pguyot/arm-runner-action
          cpu: cortex-a53
          base_image: raspios_lite_arm64:latest

    steps:
      - name: Checkout app
        uses: actions/checkout@v6

      - uses: pguyot/arm-runner-action@v2
        with:
          base_image: ${{ matrix.base_image }}
          cpu: ${{ matrix.cpu }}
          shell: /bin/bash -eo pipefail
          image_additional_mb: 6000
          # Avoids the need for copy_artifact_path later.
          bind_mount_repository: true
          commands: |
            # get git
            sudo apt-get update
            sudo apt-get install -y git

            # GITHUB_ENV and GITHUB_PATH are defined now, but invalid,
            # they refer to filenames inside ubuntu-latest runner
            # which don't exist inside ARM runner.
            # Unset them, to prevent using by setup_castle_engine .
            unset GITHUB_ENV
            unset GITHUB_PATH

            # get and run setup_castle_engine
            pushd /tmp/
            cd /tmp/
            git clone https://github.com/castle-engine/castle-build-ci.git \
              --depth=1 --single-branch --branch=master
            castle-build-ci/install_dependencies
            castle-build-ci/setup_castle_engine
            source setup_castle_engine_env.sh
            popd

            # build application
            cd test_project && castle-engine package --verbose

      - name: Archive Artifacts
        uses: actions/upload-artifact@v6
        with:
          name: build-arm-${{ matrix.arch }}
          path: |
            test_project/*.zip
            test_project/*.tar.gz
            test_project/*.apk
          if-no-files-found: error

  # Build using lazbuild, just to test that --lazarus=true option works.
  build_lazarus:
    name: Build using Lazarus (lazbuild)
    strategy:
      matrix:
        runner: [
          ubuntu-latest,
          windows-latest
          # TODO: macOS on both CPUs fails with FPC internal error:
          # /Users/runner/work/castle-build-ci/castle-build-ci/test_project/./code/gameinitialize.pas(50,1) Fatal: Internal error 200609171
          # Test on real macOS and tweak to make it work.
          #macos-latest, # macOS with Aarch64 (macOS Silicon)
          #macos-15-intel # last macOS with Intel
        ]
    runs-on: ${{ matrix.runner }}
    steps:
      - name: Checkout application
        uses: actions/checkout@v6

      - name: Setup Castle Game Engine (with Lazarus)
        run: |
          cd /tmp/ # temporary directory, to be separate from the current project files
          git clone https://github.com/castle-engine/castle-build-ci.git \
            --depth=1 --single-branch --branch=master
          castle-build-ci/install_dependencies
          castle-build-ci/setup_castle_engine --install-lazarus=true

      - name: Package
        run: |
          cd test_project
          # Temporarily add build_using_lazbuild to manifest, to force using lazbuild
          # Also, to workaround issue fixed in https://github.com/castle-engine/castle-engine/commit/acda954bc9ec02b9b8be0953cab2da8f9a74df14 ,
          # add standalone_source to let our CGE build tool figure out the LPI name.
          sed -i.backup -e 's|<project|<project build_using_lazbuild="true" standalone_source="test_project_standalone.dpr"|' CastleEngineManifest.xml
          castle-engine generate-program # generate LPI
          castle-engine package --verbose # package using lazbuild using LPI
          mv -f CastleEngineManifest.xml.backup CastleEngineManifest.xml

      - name: Archive Artifacts
        uses: actions/upload-artifact@v6
        with:
          name: build-lazarus-${{ matrix.runner }}
          path: |
            test_project/*.zip
            test_project/*.tar.gz
            test_project/*.apk
          if-no-files-found: error
